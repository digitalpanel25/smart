# Comment fonctionne SmartVoice ? ü§ñ

## Vue d'ensemble

SmartVoice est un syst√®me intelligent qui transforme vos questions en langage naturel en r√©ponses pr√©cises bas√©es sur vos donn√©es. Voici comment je fonctionne √©tape par √©tape.

---

## üì• √âTAPE 1 : R√©ception de votre question

**Quand vous me posez une question :**

1. **Si c'est de l'audio** : Je re√ßois votre fichier audio (WAV, MP3, etc.)
2. **Si c'est du texte** : Je re√ßois directement votre texte

**Ce que je fais :**
- Je v√©rifie que votre question n'est pas vide
- Je v√©rifie qu'elle ne d√©passe pas 1000 caract√®res
- Je g√©n√®re un identifiant unique (task_id) pour suivre votre requ√™te
- Je commence √† mesurer le temps de traitement

**Exemple :** Vous me demandez : *"Quel est le chiffre d'affaire de ce mois ?"*

---

## üé§ √âTAPE 2 : Transcription audio (si audio fourni)

**Si vous avez envoy√© de l'audio :**

1. J'utilise le service Speech-to-Text (STT) d'OpenAI
2. Je convertis votre audio en texte
3. Je stocke le texte transcrit

**Exemple :** Votre audio "quel-est-le-chiffre-d-affaire.mp3" devient le texte : *"Quel est le chiffre d'affaire de ce mois ?"*

**Note :** Si vous envoyez directement du texte, je saute cette √©tape.

---

## üß† √âTAPE 3 : Compr√©hension de votre intention

**Maintenant que j'ai votre texte, je dois comprendre ce que vous voulez :**

1. J'utilise un LLM (Language Model) pour analyser votre question
2. J'extrais :
   - **L'intention** : Que voulez-vous savoir ? (ex: "ventes_mois_dernier", "prediction_chiffre_affaire")
   - **Les entit√©s** : Quelles m√©triques ? Quelle p√©riode ? (ex: m√©trique="chiffre d'affaire", p√©riode="ce mois")
   - **Le type de question** : 
     - **Pr√©dictive** ? (ex: "Quel sera le CA la semaine prochaine ?")
     - **Analytique** ? (ex: "De combien les ventes ont-elles augment√© ?")
     - **Descriptive** ? (ex: "Combien de ventes avons-nous ?")

**Exemple :** Pour *"Quel est le chiffre d'affaire de ce mois ?"*
- Intention : `chiffre_affaire_mois`
- M√©trique : `chiffre d'affaire`
- P√©riode : `ce mois`
- Type : `descriptive`

---

## üóÑÔ∏è √âTAPE 4 : D√©couverte de votre base de donn√©es

**Je dois comprendre votre base de donn√©es :**

1. Je me connecte √† votre base de donn√©es (SQLite, PostgreSQL, MySQL, MongoDB, etc.)
2. Je d√©tecte le **domaine m√©tier** de votre base :
   - Est-ce une base de ventes/commerce ?
   - Est-ce une base m√©dicale ?
   - Est-ce une base RH ?
   - etc.
3. Je liste toutes les tables disponibles
4. Je d√©tecte quelles tables sont pertinentes pour votre question

**Exemple :** 
- Domaine d√©tect√© : `ventes_commerce`
- Tables disponibles : `sales`, `products`, `customers`, `employees`
- Tables pertinentes pour votre question : `sales`

---

## üîç √âTAPE 5 : V√©rification de coh√©rence

**Je v√©rifie que votre question correspond √† votre base de donn√©es :**

1. Je compare le domaine de votre question avec le domaine de votre base
2. Si incoh√©rence d√©tect√©e (ex: question sur "patients" mais base de "ventes") :
   - Je vous explique poliment que votre question ne correspond pas
   - Je vous sugg√®re de poser une question sur le bon domaine
   - Je m'arr√™te l√†

**Exemple :** 
- Votre question : *"Combien de patients ont √©t√© soign√©s ?"*
- Votre base : Base de ventes
- Ma r√©ponse : *"Je comprends votre question concernant m√©dical et sant√©, mais la base de donn√©es actuellement connect√©e contient des informations sur ventes et commerce..."*

---

## üìä √âTAPE 6 : Construction du contexte des tables

**Je pr√©pare les informations sur les tables pertinentes :**

1. Pour chaque table pertinente, je r√©cup√®re :
   - Les noms des colonnes
   - Les types de donn√©es
   - Les relations entre tables (cl√©s √©trang√®res)
   - Des exemples de donn√©es
2. Je construis un "contexte" d√©taill√© que je vais donner au LLM

**Exemple :** 
```
Table: sales
- Colonnes: id (INTEGER), date (DATE), amount (DECIMAL), customer_id (INTEGER), product_id (INTEGER)
- Relations: customer_id ‚Üí customers.id, product_id ‚Üí products.id
- Exemple: {id: 1, date: "2024-01-15", amount: 1500.00, customer_id: 5, product_id: 12}
```

---

## üîß √âTAPE 7 : G√©n√©ration de la requ√™te SQL

**Je g√©n√®re la requ√™te SQL pour r√©pondre √† votre question :**

1. Je donne au LLM :
   - Votre question
   - Le contexte des tables
   - Des instructions pr√©cises sur comment g√©n√©rer le SQL

2. **Si c'est une question pr√©dictive** (ex: "Quel sera le CA la semaine prochaine ?") :
   - Je g√©n√®re un SQL pour r√©cup√©rer les donn√©es historiques
   - Exemple : `SELECT date, amount FROM sales ORDER BY date LIMIT 1000`

3. **Si c'est une question analytique** (ex: "De combien les ventes ont-elles augment√© ?") :
   - Je g√©n√®re un SQL avec des calculs (pourcentages, variations, etc.)
   - Exemple : `SELECT date, amount, LAG(amount) OVER (ORDER BY date) as amount_precedent, ((amount - LAG(amount) OVER (ORDER BY date)) / LAG(amount) OVER (ORDER BY date)) * 100 as pourcentage_augmentation FROM sales ORDER BY date`

4. **Si c'est une question simple** (ex: "Combien de ventes avons-nous ?") :
   - Je g√©n√®re un SQL simple avec agr√©gations
   - Exemple : `SELECT COUNT(*) as total_ventes FROM sales`

**Exemple :** Pour *"Quel est le chiffre d'affaire de ce mois ?"*
- SQL g√©n√©r√© : `SELECT SUM(amount) as total_ca FROM sales WHERE strftime('%Y-%m', date) = strftime('%Y-%m', 'now')`

---

## ‚úÖ √âTAPE 8 : Validation de la requ√™te SQL

**Avant d'ex√©cuter le SQL, je v√©rifie qu'il est s√ªr :**

1. Je v√©rifie qu'il n'y a pas d'op√©rations dangereuses :
   - Pas de `DROP`, `DELETE`, `UPDATE`, `INSERT`
   - Seulement des `SELECT`
2. Je v√©rifie la syntaxe SQL
3. Si la requ√™te est dangereuse, je la bloque et je vous informe

**Exemple :** Si quelqu'un essaie `DROP TABLE sales`, je bloque et je retourne une erreur.

---

## üöÄ √âTAPE 9 : Ex√©cution de la requ√™te SQL

**J'ex√©cute la requ√™te SQL sur votre base de donn√©es :**

1. Je me connecte √† la base
2. J'ex√©cute la requ√™te SQL
3. Je r√©cup√®re les r√©sultats (lignes de donn√©es)
4. Je mesure le temps d'ex√©cution

**Exemple :** 
- SQL ex√©cut√© : `SELECT SUM(amount) as total_ca FROM sales WHERE strftime('%Y-%m', date) = strftime('%Y-%m', 'now')`
- R√©sultats : `[{"total_ca": 45000.50}]`
- Temps d'ex√©cution : 2.5 millisecondes

---

## üêº √âTAPE 10 : Analyse avec Pandas (NOUVEAU)

**Je transforme les donn√©es SQL en dataset Pandas pour des analyses avanc√©es :**

1. Je donne au LLM :
   - Votre question originale
   - Les donn√©es SQL r√©cup√©r√©es
   - Le contexte des tables
   - L'intention extraite

2. Le LLM g√©n√®re du code Python/Pandas qui :
   - Cr√©e un DataFrame Pandas √† partir des donn√©es SQL
   - Effectue des analyses statistiques (moyennes, m√©dianes, corr√©lations, etc.)
   - D√©tecte des patterns et tendances
   - G√©n√®re des insights

3. J'ex√©cute ce code de mani√®re s√©curis√©e (sandbox)

4. Je r√©cup√®re les r√©sultats de l'analyse Pandas

**Exemple :** 
- Donn√©es SQL : 100 lignes de ventes
- Code Pandas g√©n√©r√© : Calcule les statistiques, corr√©lations, distributions
- R√©sultats : `{"summary": "...", "statistics": {...}, "insights": [...]}`

---

## ü§ñ √âTAPE 11 : Machine Learning (si question pr√©dictive)

**Si votre question est pr√©dictive, j'utilise le Machine Learning :**

1. Je d√©tecte les colonnes de date et de valeur dans les donn√©es
2. J'utilise le mod√®le Prophet (ou un fallback simple) pour :
   - Analyser les tendances historiques
   - D√©tecter la saisonnalit√©
   - G√©n√©rer des pr√©dictions pour le futur

3. Je g√©n√®re des sc√©narios :
   - **Optimiste** : Meilleur cas
   - **R√©aliste** : Cas le plus probable
   - **Pessimiste** : Pire cas

4. Je calcule un niveau de confiance

**Exemple :** Pour *"Quel sera le chiffre d'affaire la semaine prochaine ?"*
- Pr√©diction r√©aliste : 52 000‚Ç¨
- Pr√©diction optimiste : 58 000‚Ç¨
- Pr√©diction pessimiste : 46 000‚Ç¨
- Confiance : 85%

---

## üìà √âTAPE 12 : Analyse m√©tier compl√®te (si pr√©dictive)

**Pour les questions pr√©dictives, je fais une analyse m√©tier approfondie :**

1. **EDA (Exploratory Data Analysis) compl√®te** :
   - Qualit√© des donn√©es
   - Tendances identifi√©es
   - Saisonnalit√©s d√©tect√©es
   - Points d'attention

2. **G√©n√©ration de recommandations m√©tier** :
   - Actions imm√©diates
   - Actions pr√©ventives
   - Actions strat√©giques
   - Signaux d'alerte

3. **Contr√¥le qualit√©** :
   - V√©rification de la coh√©rence
   - Identification des limites
   - √âvaluation des risques

---

## üìù √âTAPE 13 : G√©n√©ration de la r√©ponse textuelle

**Je transforme tous ces r√©sultats en une r√©ponse naturelle en fran√ßais :**

1. Je pr√©pare un r√©sum√© de toutes les donn√©es :
   - Les r√©sultats SQL
   - Les analyses Pandas (statistiques, insights, corr√©lations)
   - Les pr√©dictions ML (si applicable)
   - Les recommandations m√©tier (si applicable)

2. Je donne tout √ßa au LLM avec des instructions pr√©cises :
   - R√©pondre directement √† la question
   - Utiliser les donn√©es et analyses
   - √ätre clair et naturel
   - √âviter le jargon technique inutile
   - Formater les montants et dates de mani√®re lisible

3. Le LLM g√©n√®re une r√©ponse en langage naturel

4. Je nettoie la r√©ponse :
   - J'enl√®ve les d√©tails techniques inutiles
   - Je convertis le JSON brut en texte naturel
   - Je formate les montants (ex: 32702.94 ‚Üí "32 702,94 euros")
   - Je formate les dates (ex: "2024-07-08" ‚Üí "8 juillet 2024")

**Exemple :** Pour *"Quel est le chiffre d'affaire de ce mois ?"*
- R√©ponse g√©n√©r√©e : *"Le chiffre d'affaire de ce mois est de 45 000,50 euros."*

---

## üì§ √âTAPE 14 : Retour de la r√©ponse

**Je vous renvoie tous les r√©sultats :**

1. **R√©ponse textuelle principale** : La r√©ponse en langage naturel
2. **D√©tails techniques** (optionnel) :
   - La requ√™te SQL g√©n√©r√©e
   - Les r√©sultats SQL
   - Les analyses Pandas
   - Les pr√©dictions ML
   - Le temps de traitement

**Format de retour :**
```json
{
  "task_id": "...",
  "status": "completed",
  "text_response": "Le chiffre d'affaire de ce mois est de 45 000,50 euros.",
  "sql_query": "SELECT SUM(amount)...",
  "sql_result": {...},
  "ml_result": {...},
  "processing_time_ms": 15462.47
}
```

---

## üéØ R√©sum√© du flux complet

```
Votre Question (texte/audio)
    ‚Üì
[1] Transcription audio ‚Üí Texte (si audio)
    ‚Üì
[2] Extraction intention et entit√©s
    ‚Üì
[3] D√©couverte de la base de donn√©es
    ‚Üì
[4] V√©rification de coh√©rence domaine
    ‚Üì
[5] Construction contexte tables
    ‚Üì
[6] G√©n√©ration requ√™te SQL
    ‚Üì
[7] Validation SQL (s√©curit√©)
    ‚Üì
[8] Ex√©cution SQL ‚Üí Donn√©es
    ‚Üì
[9] Analyse Pandas (code g√©n√©r√© + ex√©cut√©)
    ‚Üì
[10] Machine Learning (si pr√©dictive)
    ‚Üì
[11] Analyse m√©tier compl√®te (si pr√©dictive)
    ‚Üì
[12] G√©n√©ration r√©ponse textuelle naturelle
    ‚Üì
[13] Retour r√©ponse √† l'utilisateur
```

---

## üîí S√©curit√© et validation

**√Ä chaque √©tape, je v√©rifie :**

- ‚úÖ Que les requ√™tes SQL sont s√ªres (pas de DROP, DELETE, etc.)
- ‚úÖ Que les donn√©es sont valides
- ‚úÖ Que les calculs sont coh√©rents
- ‚úÖ Que le code Pandas g√©n√©r√© est s√©curis√© (sandbox)
- ‚úÖ Que les pr√©dictions ML sont raisonnables

---

## üö® Gestion des erreurs

**Si quelque chose ne va pas :**

1. Je d√©tecte l'erreur
2. Je la log dans les fichiers de log
3. Je g√©n√®re un message d'erreur clair pour vous
4. Je sugg√®re des solutions si possible

**Exemples d'erreurs g√©r√©es :**
- Base de donn√©es non connect√©e
- Table inexistante
- Requ√™te SQL invalide
- LLM non disponible
- Donn√©es insuffisantes pour ML

---

## üí° Points cl√©s

1. **100% dynamique** : Je m'adapte √† n'importe quelle structure de base de donn√©es
2. **Intelligent** : Je comprends le contexte et g√©n√®re des requ√™tes appropri√©es
3. **S√©curis√©** : Je valide tout avant d'ex√©cuter
4. **Naturel** : Je r√©ponds en langage naturel, pas en JSON brut
5. **Complet** : Pour les questions pr√©dictives, je fais une analyse m√©tier compl√®te

---

**C'est comme √ßa que je fonctionne ! üéâ**
